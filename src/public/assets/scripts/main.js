biigle.$viewModel("annotation-catalog-container",function(e){var i=biigle.$require("largo.api.labels"),t=biigle.$require("annotationCatalog.labelTree");new Vue({el:e,mixins:[biigle.$require("largo.mixins.largoContainer")],components:{catalogImageGrid:biigle.$require("largo.components.catalogImageGrid")},data:{labelTrees:[t]},methods:{queryAnnotations:function(e){return i.queryAnnotations({id:e.id})}}})}),biigle.$viewModel("largo-container",function(e){var i=biigle.$require("largo.api.volumes"),t=biigle.$require("largo.volumeId");new Vue({el:e,mixins:[biigle.$require("largo.mixins.largoContainer")],data:{labelTrees:biigle.$require("largo.labelTrees")},methods:{queryAnnotations:function(e){return i.queryAnnotations({id:t,label_id:e.id})},performSave:function(e){return i.save({id:t},e)}}})}),biigle.$viewModel("largo-title",function(e){var i=biigle.$require("events");new Vue({el:e,data:{step:0,count:0,dismissedCount:0},computed:{shownCount:function(){return this.isInDismissStep?this.count:this.dismissedCount},isInDismissStep:function(){return 0===this.step},isInRelabelStep:function(){return 1===this.step}},methods:{updateStep:function(e){this.step=e},updateCount:function(e){this.count=e},updateDismissedCount:function(e){this.dismissedCount=e}},created:function(){i.$on("annotations-count",this.updateCount),i.$on("dismissed-annotations-count",this.updateDismissedCount),i.$on("step",this.updateStep)}})}),biigle.$viewModel("project-largo-container",function(e){var i=biigle.$require("largo.api.projects"),t=biigle.$require("largo.projectId");new Vue({el:e,mixins:[biigle.$require("largo.mixins.largoContainer")],data:{labelTrees:biigle.$require("largo.labelTrees")},methods:{queryAnnotations:function(e){return i.queryAnnotations({id:t,label_id:e.id})},performSave:function(e){return i.save({id:t},e)}}})}),biigle.$declare("largo.api.labels",Vue.resource("api/v1/labels{/id}/annotations",{},{queryAnnotations:{method:"GET"}})),biigle.$declare("largo.api.projects",Vue.resource("api/v1/projects{/id}/largo",{},{queryAnnotations:{method:"GET",url:"api/v1/projects{/id}/annotations/filter/label{/label_id}"}})),biigle.$declare("largo.api.volumes",Vue.resource("api/v1/volumes{/id}/largo",{},{queryAnnotations:{method:"GET",url:"api/v1/volumes{/id}/annotations/filter/label{/label_id}"},queryExampleAnnotations:{method:"GET",url:"api/v1/volumes{/id}/annotations/examples{/label_id}"}})),biigle.$component("largo.components.annotationPatch",{mixins:[biigle.$require("largo.mixins.annotationPatch")],props:{id:{type:String,required:!0},uuid:{type:String,required:!0},label:{type:Object,required:!0},emptySrc:{type:String,required:!0},urlTemplate:{type:String,required:!0}},data:function(){return{url:""}},computed:{title:function(){return"Example annotation for label "+this.label.name},src:function(){return this.url||this.emptySrc}},methods:{showEmptyImage:function(){this.url=""}},created:function(){this.url=this.getUrl()}}),biigle.$component("largo.components.catalogImageGrid",{mixins:[biigle.$require("volumes.components.imageGrid")],components:{imageGridImage:biigle.$require("largo.components.catalogImageGridImage")}}),biigle.$component("largo.components.catalogImageGridImage",{mixins:[biigle.$require("volumes.components.imageGridImage"),biigle.$require("largo.mixins.annotationPatch")],template:'<figure class="image-grid__image image-grid__image--catalog" :class="classObject"><a v-if="showAnnotationLink" :href="showAnnotationLink" target="_blank" title="Show the annotation in the annotation tool"><img :src="url || emptyUrl" @error="showEmptyImage"></a><img v-else :src="url || emptyUrl" @error="showEmptyImage"></figure>',computed:{showAnnotationLink:function(){var e=biigle.$require("annotationCatalog.showAnnotationRoute");return e?e+this.image.id:""},id:function(){return this.image.id},uuid:function(){return this.image.uuid},urlTemplate:function(){return biigle.$require("largo.patchUrlTemplate")}}}),biigle.$component("largo.components.dismissImageGrid",{mixins:[biigle.$require("volumes.components.imageGrid")],components:{imageGridImage:biigle.$require("largo.components.dismissImageGridImage")}}),biigle.$component("largo.components.dismissImageGridImage",{mixins:[biigle.$require("volumes.components.imageGridImage"),biigle.$require("largo.mixins.annotationPatch")],template:'<figure class="image-grid__image" :class="classObject" :title="title"><div v-if="selectable" class="image-icon"><i class="fas" :class="iconClass"></i></div><img @click="toggleSelect" :src="url || emptyUrl" @error="showEmptyImage"><div v-if="showAnnotationLink" class="image-buttons"><a :href="showAnnotationLink" target="_blank" class="image-button" title="Show the annotation in the annotation tool"><span class="fa fa-external-link-square-alt" aria-hidden="true"></span></a></div></figure>',computed:{showAnnotationLink:function(){var e=biigle.$require("largo.showAnnotationRoute");return e?e+this.image.id:""},selected:function(){return this.image.dismissed},title:function(){return this.selected?"Undo dismissing this annotation":"Dismiss this annotation"},id:function(){return this.image.id},uuid:function(){return this.image.uuid},urlTemplate:function(){return biigle.$require("largo.patchUrlTemplate")}}}),biigle.$require("annotations.components.labelsTabPlugins").exampleAnnotations={mixins:[biigle.$require("core.mixins.loader")],components:{annotationPatch:biigle.$require("largo.components.annotationPatch")},props:{label:{default:null},volumeId:{type:Number,required:!0},count:{type:Number,default:3}},data:function(){return{exampleLabel:null,exampleAnnotations:[],cache:{},shown:!0}},computed:{isShown:function(){return this.shown&&null!==this.label},hasExamples:function(){return this.exampleLabel&&this.exampleAnnotations&&Object.keys(this.exampleAnnotations).length>0},volumesApi:function(){return biigle.$require("largo.api.volumes")}},methods:{parseResponse:function(e){return e.data},setExampleAnnotations:function(e){(!e[0].hasOwnProperty("annotations")||Object.keys(e[0].annotations).length<this.count)&&delete this.cache[e[1]],e[0].hasOwnProperty("label")&&e[0].label.id===e[1]||delete this.cache[e[1]],this.label&&this.label.id===e[1]&&(this.exampleAnnotations=e[0].annotations,this.exampleLabel=e[0].label)},updateShown:function(e){this.shown=e},updateExampleAnnotations:function(){this.exampleAnnotations=[],this.isShown&&(this.startLoading(),this.cache.hasOwnProperty(this.label.id)||(this.cache[this.label.id]=this.volumesApi.queryExampleAnnotations({id:this.volumeId,label_id:this.label.id,take:this.count}).then(this.parseResponse)),Vue.Promise.all([this.cache[this.label.id],this.label.id]).then(this.setExampleAnnotations).finally(this.finishLoading))}},watch:{label:function(){this.updateExampleAnnotations()},shown:function(){this.updateExampleAnnotations()}},created:function(){biigle.$require("events").$on("settings.exampleAnnotations",this.updateShown)}},biigle.$component("largo.components.relabelImageGrid",{mixins:[biigle.$require("volumes.components.imageGrid")],components:{imageGridImage:biigle.$require("largo.components.relabelImageGridImage")}}),biigle.$component("largo.components.relabelImageGridImage",{mixins:[biigle.$require("volumes.components.imageGridImage"),biigle.$require("largo.mixins.annotationPatch")],template:'<figure class="image-grid__image image-grid__image--relabel" :class="classObject" :title="title"><div v-if="selectable" class="image-icon"><i class="fas" :class="iconClass"></i></div><img @click="toggleSelect" :src="url || emptyUrl" @error="showEmptyImage"><div v-if="showAnnotationLink" class="image-buttons"><a :href="showAnnotationLink" target="_blank" class="image-button" title="Show the annotation in the annotation tool"><span class="fa fa-external-link-square-alt" aria-hidden="true"></span></a></div><div v-if="selected" class="new-label"><span class="new-label__color" :style="newLabelStyle"></span> <span class="new-label__name" v-text="image.newLabel.name"></span></div></figure>',computed:{showAnnotationLink:function(){var e=biigle.$require("largo.showAnnotationRoute");return e?e+this.image.id:""},selected:function(){return this.image.newLabel},title:function(){return this.selected?"Revert changing the label of this annotation":"Change the label of this annotation"},newLabelStyle:function(){return{"background-color":"#"+this.image.newLabel.color}},id:function(){return this.image.id},uuid:function(){return this.image.uuid},urlTemplate:function(){return biigle.$require("largo.patchUrlTemplate")}}}),biigle.$require("annotations.components.settingsTabPlugins").exampleAnnotations={components:{powerButton:biigle.$require("annotations.components.powerButton")},props:{settings:{type:Object,required:!0}},data:function(){return{isShown:!0}},methods:{hide:function(){this.isShown=!1,this.settings.set("exampleAnnotations",!1)},show:function(){this.isShown=!0,this.settings.delete("exampleAnnotations")}},watch:{isShown:function(e){biigle.$require("events").$emit("settings.exampleAnnotations",e)}},created:function(){this.settings.has("exampleAnnotations")&&(this.isShown=this.settings.get("exampleAnnotations"))}},biigle.$component("largo.mixins.annotationPatch",{computed:{patchPrefix:function(){return this.uuid[0]+this.uuid[1]+"/"+this.uuid[2]+this.uuid[3]+"/"+this.uuid}},methods:{getUrl:function(){return this.urlTemplate.replace("{prefix}",this.patchPrefix).replace("{id}",this.id)}}}),biigle.$declare("largo.mixins.largoContainer",{mixins:[biigle.$require("core.mixins.loader")],components:{labelTrees:biigle.$require("labelTrees.components.labelTrees"),sidebar:biigle.$require("core.components.sidebar"),sidebarTab:biigle.$require("core.components.sidebarTab"),powerToggle:biigle.$require("core.components.powerToggle"),dismissImageGrid:biigle.$require("largo.components.dismissImageGrid"),relabelImageGrid:biigle.$require("largo.components.relabelImageGrid")},data:{labelTrees:[],step:0,selectedLabel:null,annotationsCache:{},lastSelectedImage:null,forceChange:!1},computed:{isInDismissStep:function(){return 0===this.step},isInRelabelStep:function(){return 1===this.step},annotations:function(){return this.selectedLabel&&this.annotationsCache.hasOwnProperty(this.selectedLabel.id)?this.annotationsCache[this.selectedLabel.id]:[]},allAnnotations:function(){var e=[];for(var i in this.annotationsCache)this.annotationsCache.hasOwnProperty(i)&&Array.prototype.push.apply(e,this.annotationsCache[i]);return e},hasNoAnnotations:function(){return this.selectedLabel&&!this.loading&&0===this.annotations.length},dismissedAnnotations:function(){return this.allAnnotations.filter(function(e){return e.dismissed})},annotationsWithNewLabel:function(){return this.dismissedAnnotations.filter(function(e){return!!e.newLabel})},hasDismissedAnnotations:function(){return this.dismissedAnnotations.length>0},dismissedToSave:function(){for(var e=this.dismissedAnnotations,i={},t=e.length-1;t>=0;t--)i.hasOwnProperty(e[t].label_id)?i[e[t].label_id].push(e[t].id):i[e[t].label_id]=[e[t].id];return i},changedToSave:function(){for(var e=this.annotationsWithNewLabel,i={},t=e.length-1;t>=0;t--)i.hasOwnProperty(e[t].newLabel.id)?i[e[t].newLabel.id].push(e[t].id):i[e[t].newLabel.id]=[e[t].id];return i},toDeleteCount:function(){return this.dismissedAnnotations.length-this.annotationsWithNewLabel.length},events:function(){return biigle.$require("events")},saveButtonClass:function(){return this.forceChange?"btn-danger":"btn-success"}},methods:{getAnnotations:function(e){if(!this.annotationsCache.hasOwnProperty(e.id)){var i=this;Vue.set(i.annotationsCache,e.id,[]),this.startLoading(),this.queryAnnotations(e).then(function(t){i.gotAnnotations(e,t.data)},biigle.$require("messages.store").handleErrorResponse).finally(this.finishLoading)}},gotAnnotations:function(e,i){i=Object.keys(i).map(function(t){return{id:t,uuid:i[t],label_id:e.id,dismissed:!1,newLabel:null}}).sort(function(e,i){return i.id-e.id}),Vue.set(this.annotationsCache,e.id,i)},handleSelectedLabel:function(e){this.selectedLabel=e,this.isInDismissStep&&this.getAnnotations(e)},handleDeselectedLabel:function(){this.selectedLabel=null},handleSelectedImageDismiss:function(e,i){e.dismissed?(e.dismissed=!1,e.newLabel=null):(e.dismissed=!0,i.shiftKey&&this.lastSelectedImage?this.dismissAllImagesBetween(e,this.lastSelectedImage):this.lastSelectedImage=e)},goToRelabel:function(){this.step=1,this.lastSelectedImage=null},goToDismiss:function(){this.step=0,this.lastSelectedImage=null,this.selectedLabel&&this.getAnnotations(this.selectedLabel)},handleSelectedImageRelabel:function(e,i){e.newLabel?this.selectedLabel&&e.newLabel.id!==this.selectedLabel.id?e.newLabel=this.selectedLabel:e.newLabel=null:this.selectedLabel&&(e.newLabel=this.selectedLabel,i.shiftKey&&this.lastSelectedImage?this.relabelAllImagesBetween(e,this.lastSelectedImage):this.lastSelectedImage=e)},save:function(){this.loading||this.toDeleteCount>0&&!confirm("This might delete "+this.toDeleteCount+" annotation(s). Continue?")||(this.startLoading(),this.performSave({dismissed:this.dismissedToSave,changed:this.changedToSave,force:this.forceChange}).then(this.saved,biigle.$require("messages.store").handleErrorResponse).finally(this.finishLoading))},saved:function(){biigle.$require("messages.store").success("Saved. You can now start a new re-evaluation session."),this.step=0;for(var e in this.annotationsCache)this.annotationsCache.hasOwnProperty(e)&&delete this.annotationsCache[e];this.handleSelectedLabel(this.selectedLabel)},performOnAllImagesBetween:function(e,i,t){var n=this.allAnnotations.indexOf(e),a=this.allAnnotations.indexOf(i);if(a<n){var s=a;a=n,n=s}for(var o=n+1;o<a;o++)t(this.allAnnotations[o])},dismissAllImagesBetween:function(e,i){this.performOnAllImagesBetween(e,i,function(e){e.dismissed=!0})},relabelAllImagesBetween:function(e,i){var t=this.selectedLabel;this.performOnAllImagesBetween(e,i,function(e){e.dismissed&&(e.newLabel=t)})},enableForceChange:function(){this.forceChange=!0},disableForceChange:function(){this.forceChange=!1}},watch:{annotations:function(e){this.events.$emit("annotations-count",e.length)},dismissedAnnotations:function(e){this.events.$emit("dismissed-annotations-count",e.length)},step:function(e){this.events.$emit("step",e)}}});