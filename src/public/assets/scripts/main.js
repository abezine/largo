angular.module("biigle.largo",["biigle.volumes"]),angular.module("biigle.largo").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("biigle.largo").constant("VOLUME_ID","largo"),angular.module("biigle.largo").constant("VOLUME_IMAGES",[]),angular.module("biigle.largo").controller("LargoController",["$scope","labels","annotations","msg",function(e,n,t,i){"use strict";var o=0,a={DISMISS:0,RELABEL:1},l=function(){document.getElementById("dismiss-mode-title").classList.toggle("ng-hide"),document.getElementById("re-labelling-mode-title").classList.toggle("ng-hide")};e.annotationsExist=t.exist,e.isInDismissMode=function(){return o===a.DISMISS},e.goToDismiss=function(){o=a.DISMISS,l(),t.goToStep(o)},e.isInReLabellingMode=function(){return o===a.RELABEL},e.goToReLabelling=function(){o=a.RELABEL,l(),t.goToStep(o)},e.saveReLabelling=function(){t.save().then(function(){e.goToDismiss(),i.success("Saved. You can now start a new re-evaluation session.")})},e.hasSelectedLabel=n.hasSelectedLabel,e.getSelectedLabelName=function(){return n.getSelectedLabel().name},e.isLoading=t.isLoading,e.isSaving=t.isSaving,e.canContinue=t.canContinue,e.getClass=function(){return{"dismiss-mode":e.isInDismissMode(),"re-labelling-mode":e.isInReLabellingMode()}},e.$watch(n.getSelectedLabel,t.handleSelectedLabel)}]),angular.module("biigle.largo").directive("largoFigure",function(){"use strict";return{restrict:"A",controller:["$scope","annotations","msg",function(e,n,t){e.changedLabel=null;var i=function(){e.changedLabel=n.getChangedLabel(e.id)},o=function(){return n.isDismissed(e.id)},a=function(){return null!==e.changedLabel};e.isChanged=a,e.handleClick=function(t){n.selectAnnotation(e.id),i()},e.getTitle=function(){return e.isInDismissMode()?o()?"Undo dismissing this annotation":"Dismiss this annotation":a()?"Revert changing the label of this annotation":"Change the label of this annotation"},e.getClass=function(){return{"annotation-selected":e.isInDismissMode()&&o()||e.isInReLabellingMode()&&a()}},i()}]}}),angular.module("biigle.largo").factory("Largo",["$resource","URL",function(e,n){"use strict";return e(n+"/api/v1/volumes/:volume_id/largo")}]),angular.module("biigle.largo").factory("VolumeFilterAnnotationLabel",["$resource","URL",function(e,n){"use strict";return e(n+"/api/v1/volumes/:volume_id/annotations/filter/label/:label_id")}]),angular.module("biigle.largo").service("annotations",["VOLUME_IMAGES","largo","labels","images","msg",function(e,n,t,i,o){"use strict";var a={},l=!1,s=!1,r=!1,u={},c=[],d={},g=0,f={DISMISS:0,RELABEL:1},h=this,b=document.getElementById("annotation-count"),m=function(n){n=n||e.length,b.innerHTML=n},L=function(e){c.indexOf(e)===-1&&c.push(e)},S=function(e){var n=c.indexOf(e);n!==-1&&c.splice(n,1),d.hasOwnProperty(e)&&delete d[e]},v=function(e){s=!1,o.responseError(e)},p=function(){r=!1,a={},u={},c.length=0,d={}},I=function(e){r=!1,D(),o.responseError(e)},E=function(n){s=!1,l=n.length>0,l&&Array.prototype.push.apply(e,n),i.updateFiltering(),m()},A=function(e){var n=t.getSelectedLabel().id;if(u.hasOwnProperty(n)){var i=u[n].indexOf(e);i!==-1?(u[n].splice(i,1),S(e)):(u[n].push(e),L(e))}else u[n]=[e],L(e)},M=function(e){d.hasOwnProperty(e)?delete d[e]:d[e]=t.getSelectedLabel().id},D=function(){e.length=0,E(c),i.scrollToPercent(0)};this.selectAnnotation=function(e){g===f.DISMISS?A(e):M(e)},this.isDismissed=function(e){var n=t.getSelectedLabel().id;return u.hasOwnProperty(n)&&u[n].indexOf(e)!==-1},this.getDismissedIds=function(){return c},this.getChangedLabel=function(e){return d.hasOwnProperty(e)?t.getLabel(d[e]):null},this.handleSelectedLabel=function(t){if(t&&g!==f.RELABEL){var o=t.id;e.length=0,m(),i.updateFiltering(),i.scrollToPercent(0),a.hasOwnProperty(o)?E(a[o]):(s=!0,a[o]=n.getAnnotations(o),a[o].$promise.then(E,v))}},this.exist=function(){return l},this.isLoading=function(){return s},this.isSaving=function(){return r},this.canContinue=function(){return c.length>0},this.goToStep=function(e){g=e,g===f.DISMISS?h.handleSelectedLabel(t.getSelectedLabel()):D()},this.save=function(){r=!0,e.length=0,m(),i.updateFiltering();var t=n.save(u,d).$promise;return t.then(p,I),t}}]),angular.module("biigle.largo").service("largo",["LARGO_VOLUME_ID","VolumeFilterAnnotationLabel","Largo",function(e,n,t){"use strict";this.getAnnotations=function(t){return n.query({volume_id:e,label_id:t})},this.save=function(n,i){return t.save({volume_id:e},{dismissed:n,changed:i})}}]),angular.module("biigle.largo").service("labels",["LABEL_TREES",function(e){"use strict";var n=[],t={},i=[],o=null,a=function(){for(var i,o=function(e){var n=e.parent_id;t[i][n]?t[i][n].push(e):t[i][n]=[e]},a=e.length-1;a>=0;a--)i=e[a].name,t[i]={},e[a].labels.forEach(o),n=n.concat(e[a].labels)},l=function(e){for(var t=n.length-1;t>=0;t--)if(n[t].id===e)return n[t];return null},s=function(e){var n=e;if(i.length=0,n)for(;null!==n.parent_id;)i.unshift(n.parent_id),n=l(n.parent_id)};this.getLabel=l,this.getLabels=function(){return n},this.getLabelTrees=function(){return t},this.selectLabel=function(e){s(e),o=e},this.treeItemIsOpen=function(e){return i.indexOf(e.id)!==-1},this.treeItemIsSelected=function(e){return o&&o.id===e.id},this.getSelectedLabel=function(){return o},this.hasSelectedLabel=function(){return null!==o},a()}]);
