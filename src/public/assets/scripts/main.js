angular.module("biigle.largo",["biigle.volumes"]),angular.module("biigle.largo").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("biigle.largo").controller("LargoController",["$scope","labels","annotations","msg",function(e,n,t,i){"use strict";var o=0,l={DISMISS:0,RELABEL:1},a=function(){document.getElementById("dismiss-mode-title").classList.toggle("ng-hide"),document.getElementById("re-labelling-mode-title").classList.toggle("ng-hide")};e.annotationsExist=t.exist,e.isInDismissMode=function(){return o===l.DISMISS},e.goToDismiss=function(){o=l.DISMISS,a(),t.goToStep(o)},e.isInReLabellingMode=function(){return o===l.RELABEL},e.goToReLabelling=function(){o=l.RELABEL,a(),t.goToStep(o)},e.saveReLabelling=function(){t.save().then(function(){e.goToDismiss(),i.success("Saved. You can now start a new re-evaluation session.")})},e.hasSelectedLabel=n.hasSelectedLabel,e.getSelectedLabelName=function(){return n.getSelectedLabel().name},e.isLoading=t.isLoading,e.isSaving=t.isSaving,e.canContinue=t.canContinue,e.getClass=function(){return{"dismiss-mode":e.isInDismissMode(),"re-labelling-mode":e.isInReLabellingMode()}},e.$watch(n.getSelectedLabel,t.handleSelectedLabel)}]),angular.module("biigle.largo").constant("VOLUME_ID","largo"),angular.module("biigle.largo").constant("VOLUME_IMAGES",[]),angular.module("biigle.largo").directive("largoFigure",function(){"use strict";return{restrict:"A",controller:["$scope","annotations","msg",function(e,n,t){e.changedLabel=null;var i=function(){e.changedLabel=n.getChangedLabel(e.id)},o=function(){return n.isDismissed(e.id)},l=function(){return null!==e.changedLabel};e.isChanged=l,e.handleClick=function(t){n.selectAnnotation(e.id),i()},e.getTitle=function(){return e.isInDismissMode()?o()?"Undo dismissing this annotation":"Dismiss this annotation":l()?"Revert changing the label of this annotation":"Change the label of this annotation"},e.getClass=function(){return{"annotation-selected":e.isInDismissMode()&&o()||e.isInReLabellingMode()&&l()}},i()}]}}),angular.module("biigle.largo").factory("Largo",["$resource","URL",function(e,n){"use strict";return e(n+"/api/v1/volumes/:volume_id/largo")}]),angular.module("biigle.largo").factory("VolumeFilterAnnotationLabel",["$resource","URL",function(e,n){"use strict";return e(n+"/api/v1/volumes/:volume_id/annotations/filter/label/:label_id")}]),angular.module("biigle.largo").service("annotations",["VOLUME_IMAGES","largo","labels","images","msg",function(e,n,t,i,o){"use strict";var l={},a=!1,s=!1,r=!1,u={},c=[],g={},d=0,f={DISMISS:0,RELABEL:1},h=this,L=document.getElementById("annotation-count"),b=function(n){n=n||e.length,L.innerHTML=n},m=function(e){c.indexOf(e)===-1&&c.push(e)},S=function(e){var n=c.indexOf(e);n!==-1&&c.splice(n,1),g.hasOwnProperty(e)&&delete g[e]},v=function(e){s=!1,o.responseError(e)},p=function(){r=!1,l={},u={},c.length=0,g={}},I=function(e){r=!1,A(),o.responseError(e)},E=function(n){s=!1,a=n.length>0,a&&Array.prototype.push.apply(e,n),i.updateFiltering(),b()},M=function(e){var n=t.getSelectedLabel().id;if(u.hasOwnProperty(n)){var i=u[n].indexOf(e);i!==-1?(u[n].splice(i,1),S(e)):(u[n].push(e),m(e))}else u[n]=[e],m(e)},D=function(e){g.hasOwnProperty(e)?delete g[e]:g[e]=t.getSelectedLabel().id},A=function(){e.length=0,E(c),i.scrollToPercent(0)};this.selectAnnotation=function(e){d===f.DISMISS?M(e):D(e)},this.isDismissed=function(e){var n=t.getSelectedLabel().id;return u.hasOwnProperty(n)&&u[n].indexOf(e)!==-1},this.getDismissedIds=function(){return c},this.getChangedLabel=function(e){return g.hasOwnProperty(e)?t.getLabel(g[e]):null},this.handleSelectedLabel=function(t){if(t&&d!==f.RELABEL){var o=t.id;e.length=0,b(),i.updateFiltering(),i.scrollToPercent(0),l.hasOwnProperty(o)?E(l[o]):(s=!0,l[o]=n.getAnnotations(o),l[o].$promise.then(E,v))}},this.exist=function(){return a},this.isLoading=function(){return s},this.isSaving=function(){return r},this.canContinue=function(){return c.length>0},this.goToStep=function(e){d=e,d===f.DISMISS?h.handleSelectedLabel(t.getSelectedLabel()):A()},this.save=function(){r=!0,e.length=0,b(),i.updateFiltering();var t=n.save(u,g).$promise;return t.then(p,I),t}}]),angular.module("biigle.largo").service("labels",["LABEL_TREES",function(e){"use strict";var n=[],t={},i=[],o=null,l=function(){for(var i,o=function(e){var n=e.parent_id;t[i][n]?t[i][n].push(e):t[i][n]=[e]},l=e.length-1;l>=0;l--)i=e[l].name,t[i]={},e[l].labels.forEach(o),n=n.concat(e[l].labels)},a=function(e){for(var t=n.length-1;t>=0;t--)if(n[t].id===e)return n[t];return null},s=function(e){var n=e;if(i.length=0,n)for(;null!==n.parent_id;)i.unshift(n.parent_id),n=a(n.parent_id)};this.getLabel=a,this.getLabels=function(){return n},this.getLabelTrees=function(){return t},this.selectLabel=function(e){s(e),o=e},this.treeItemIsOpen=function(e){return i.indexOf(e.id)!==-1},this.treeItemIsSelected=function(e){return o&&o.id===e.id},this.getSelectedLabel=function(){return o},this.hasSelectedLabel=function(){return null!==o},l()}]),angular.module("biigle.largo").service("largo",["LARGO_VOLUME_ID","VolumeFilterAnnotationLabel","Largo",function(e,n,t){"use strict";this.getAnnotations=function(t){return n.query({volume_id:e,label_id:t})},this.save=function(n,i){return t.save({volume_id:e},{dismissed:n,changed:i})}}]);